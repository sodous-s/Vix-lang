name: Build Windows Release

on:
  push:
    tags:
      - 'vix-release-*'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿è°ƒè¯•

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      # è°ƒè¯•ï¼šæŸ¥çœ‹ç›®å½•ç»“æ„
      - name: Debug - List files
        run: |
          echo "=== Current directory ==="
          pwd
          ls -la
          echo "=== src directory ==="
          ls -la src/ || echo "src/ not found"
        shell: bash
      
      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          choco install winflexbison
          choco install llvm
        shell: bash
      
      # è°ƒè¯•ï¼šæŸ¥çœ‹ PATH å’Œå·¥å…·ç‰ˆæœ¬
      - name: Debug - Check tools
        run: |
          echo "=== PATH ==="
          echo $PATH
          echo "=== GCC ==="
          gcc --version || echo "gcc not found"
          echo "=== Make ==="
          make --version || echo "make not found"
          echo "=== Flex/Bison ==="
          flex --version || echo "flex not found"
          bison --version || echo "bison not found"
        shell: bash
      
      # ç¼–è¯‘
      - name: Build
        run: |
          cd src
          make V=1  # V=1 ä¼šè¾“å‡ºè¯¦ç»†ç¼–è¯‘ä¿¡æ¯
        shell: bash
      
      # è°ƒè¯•ï¼šæŸ¥çœ‹ç¼–è¯‘ç»“æœ
      - name: Debug - Check build output
        run: |
          echo "=== src after build ==="
          ls -la src/
          echo "=== Looking for vixc.exe ==="
          find . -name "*.exe" -o -name "vixc*"
        shell: bash
      
      # ä¸‹è½½ Clang-18
      - name: Download Clang-18
        run: |
          curl -L -o clang-18.1.0-windows-x64.exe https://github.com/llvm/llvm-project/releases/download/llvmorg-18.1.0/LLVM-18.1.0-win64.exe
        shell: bash
      
      # åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success()  # åªæœ‰å‰é¢æˆåŠŸæ‰åˆ›å»º
        with:
          files: |
            src/vixc.exe
            clang-18.1.0-windows-x64.exe
          name: Vixc ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          body: |
            ## Vixc ç¼–è¯‘å™¨ ${{ github.ref_name }}
            
            ### ğŸªŸ Windows ç”¨æˆ·
            - `vixc.exe` - Vixc ç¼–è¯‘å™¨
            - `clang-18.1.0-windows-x64.exe` - Clang-18 å®‰è£…ç¨‹åº
            
            ### ğŸ“ å®‰è£…æ­¥éª¤
            1. å®‰è£… Clang-18ï¼ˆåŒå‡»è¿è¡Œï¼‰
            2. å®‰è£… Flex/Bisonï¼š`choco install winflexbison`
            3. å°† vixc.exe æ‰€åœ¨ç›®å½•æ·»åŠ åˆ° PATH
            4. æ‰“å¼€æ–°çš„ç»ˆç«¯ï¼Œè¿è¡Œ `vixc -v` éªŒè¯
            
            ### ğŸ§ Linux ç”¨æˆ·
            Linux ç”¨æˆ·è¯·ç›´æ¥å…‹éš†æºç ç¼–è¯‘ï¼š
            ```bash
            git clone https://github.com/${{ github.repository }}.git
            cd Vix-lang/src
            make
            sudo make install
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}